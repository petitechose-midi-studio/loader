name: Candidate

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: candidate-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    name: build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest, macos-15-intel]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux deps
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y pkg-config libudev-dev libusb-1.0-0-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build (release)
        run: cargo build --release

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force dist | Out-Null
          $bin = "target/release/midi-studio-loader.exe"
          $out = "dist/midi-studio-loader-${{ runner.os }}-${{ runner.arch }}.zip"
          Compress-Archive -Path $bin -DestinationPath $out -Force

      - name: Package (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          out="dist/midi-studio-loader-${{ runner.os }}-${{ runner.arch }}.tar.gz"
          tar -czf "$out" -C target/release midi-studio-loader

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ runner.os }}-${{ runner.arch }}
          path: dist/*

  publish_candidate:
    name: publish candidate rc-${{ github.sha }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist_flat
          find dist -maxdepth 5 -type f -print -exec cp '{}' dist_flat/ \;
          ls -la dist_flat

      - name: Build candidate metadata
        shell: bash
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_ATTEMPT: ${{ github.run_attempt }}
        run: |
          set -euo pipefail
          sha256sum dist_flat/* > checksums.txt
          python - <<'PY'
          import datetime as dt
          import hashlib
          import json
          from pathlib import Path

          dist = Path("dist_flat")
          files = sorted(p for p in dist.iterdir() if p.is_file())
          artifacts = []
          for p in files:
              data = p.read_bytes()
              artifacts.append(
                  {
                      "filename": p.name,
                      "size": len(data),
                      "sha256": hashlib.sha256(data).hexdigest(),
                  }
              )

          payload = {
              "schema": 1,
              "repo": __import__("os").environ["GITHUB_REPOSITORY"],
              "sha": __import__("os").environ["GITHUB_SHA"],
              "workflow": "candidate.yml",
              "run_id": int(__import__("os").environ["GITHUB_RUN_ID"]),
              "run_attempt": int(__import__("os").environ["GITHUB_RUN_ATTEMPT"]),
              "generated_at": dt.datetime.now(dt.timezone.utc).isoformat(),
              "artifacts": artifacts,
          }

          Path("candidate.json").write_text(json.dumps(payload, indent=2) + "\n", encoding="utf-8")
          PY

      - name: Publish draft candidate release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: rc-${{ github.sha }}
        run: |
          set -euo pipefail
          if gh release view "$TAG" --repo "${GITHUB_REPOSITORY}" >/dev/null 2>&1; then
            gh release upload "$TAG" dist_flat/* candidate.json checksums.txt --repo "${GITHUB_REPOSITORY}" --clobber
          else
            gh release create "$TAG" dist_flat/* candidate.json checksums.txt \
              --repo "${GITHUB_REPOSITORY}" \
              --title "$TAG" \
              --notes "Candidate artifacts for ${GITHUB_SHA}" \
              --draft
          fi
